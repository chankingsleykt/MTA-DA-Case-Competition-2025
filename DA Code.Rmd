---
title: "DA Competition"
author: "Christopher Daniel Hitijahubessy"
date: "2025-11-11"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE}
# Datasets
rm(list=ls()) # Clear the console
graphics.off() # Clear the graphics window
options(scipen=20) # Turn off scientific notation
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("readr")) install.packages("readr")
if (!require("lubridate")) install.packages("lubridate")
if (!require("sqldf")) install.packages("sqldf")
library(sqldf)
library(lubridate)
library(tidyverse)
library(knitr)
library(sqldf)
Constructors <- read_csv("f1_data/Constructors.csv")

DriverPrice <- read_csv("f1_data//DriverPrice.csv")

Drivers <- read_csv("f1_data/Drivers.csv")

laps <- read_csv("f1_data//laps.csv")

QualificationResult <- read_csv("f1_data//QualificationResult.csv")

RaceResult <- read_csv("f1_data//RaceResult.csv")

RaceSchedule <- read_csv("f1_data//RaceSchedule.csv")
```

```{r}
# Converting status in RaceResult
RaceResult <- RaceResult %>%
  mutate(status_conv = case_when(
    status %in% c("+2 Laps", 
                "+1 Lap", 
                "+5 Laps", 
                "+3 Laps", 
                "Finished", 
                "Lapped", 
                "+6 Laps") ~ "Finished",
    TRUE ~ "Not Finished"
  ))

## Convert to points based on position and status in RaceResult dataset
racepoints <- RaceResult %>%
  mutate(points_conv = case_when(
    (position == 1 & status_conv == "Finished") ~ 25,
    (position == 2 & status_conv == "Finished") ~ 18,
    (position == 3 & status_conv == "Finished") ~ 15,
    (position == 4 & status_conv == "Finished")~ 12,
    (position == 5 & status_conv == "Finished") ~ 10,
    (position == 6 & status_conv == "Finished") ~ 8,
    (position == 7 & status_conv == "Finished") ~ 6,
    (position == 8 & status_conv == "Finished") ~ 4,
    (position == 9 & status_conv == "Finished") ~ 1,
    (position == 10 & status_conv == "Finished") ~ 0,
    (position %in% c(11, 12, 13, 14, 15, 16, 17, 18, 19, 20) &
       status_conv == "Finished") ~ 0,
    TRUE ~ -20
  ),
  point_gain_loss = ifelse( # Calculate points from position gained and lost
    is.na(grid_position) | is.na(position),
    0, 
    grid_position - position
  ))

# Sum up points
racepoints <- racepoints %>% 
  mutate(points_real = points_conv + point_gain_loss)

# Combine DriverPrice and racepoints
DriverPriceResult <- left_join(DriverPrice, racepoints, 
                               by = c("Driver Code"= "driver_code"))

# Combining points per driver
countPoints <- DriverPriceResult %>%
  group_by(`Driver Code`, `Driver`)%>%
  summarise(
    `Price` = max(Price), 
    `Total Points` = sum(points_real, na.rm = TRUE), 
    .groups = "drop") %>% 
  arrange(desc(`Total Points`))
kable(countPoints)

### Miscellaneous - checking NA's in position and grid_position column
RR_Miscellaneous <- racepoints %>%
  filter(is.na(position) | is.na(grid_position))
```

## Qualification Result Table
```{r}
# Converting positions to points
QualificationResult <- QualificationResult %>% 
  mutate(points = case_when(
  position == 1 ~ 10,
  position == 2 ~ 9,
  position == 3 ~ 8,
  position == 4 ~ 7,
  position == 5 ~ 6,
  position == 6 ~ 5,
  position == 7 ~ 4,
  position == 8 ~ 3,
  position == 9 ~ 2,
  position == 10 ~ 1,
  TRUE ~ 0
))

#Sum all the points
qualifypoints <- QualificationResult %>% 
  group_by(driver_code) %>%
  summarise(total_points_qualify = sum(points, na.rm = TRUE)) 

kable(qualifypoints)

# Combining countPoints and qualifypoints (excluding fastest lap)
union_data <- left_join(countPoints, qualifypoints, 
                        by = c("Driver Code" = "driver_code"))
union_data <- union_data %>% 
  mutate(subtotal = `Total Points` + total_points_qualify) %>%
  arrange(desc(subtotal))
kable(union_data)
```

```{r}

laps_modified <- laps %>% mutate(LapTimeInSeconds = (as.numeric(str_extract(LapTime, "\\d{2}(?=:\\d{2}\\.\\d)")) * 60) + as.numeric(str_extract(LapTime, "\\d{2}\\.\\d+")))

# add a new id column in RaceResult and laps_modified that assigns a unique id to each event
RaceResult$event_id <- paste(RaceResult$year,RaceResult$event_name)
laps_modified$event_id <- paste(laps_modified$year,laps_modified$event_name)

# construct a table that displays the driver and the minimum lap time per event. Note laps_modified contains entries where LapTimeInSeconds is 0 at the start of every new driver's records, these values have been rejected  
LapTimePerDriver <- sqldf("SELECT Driver, MIN(LapTimeInSeconds), event_id FROM laps_modified WHERE LapTimeInSeconds > 0 AND IsAccurate = TRUE AND Deleted = FALSE GROUP BY event_id")


LapTimePerDriver <- LapTimePerDriver %>%
  mutate(points_add = 10) %>%
  rename(driver_code = Driver)

fastest_lap_points_acc <- LapTimePerDriver %>% 
  group_by(driver_code) %>%
  summarise(point_fastest = sum(points_add))

union_data <- left_join(union_data, fastest_lap_points_acc, by = c("Driver Code" = "driver_code"))

union_data <- union_data %>% 
  mutate(point_fastest_conv = case_when(
    !is.na(point_fastest) ~ point_fastest, 
    TRUE ~ 0))

union_data <- union_data %>%
  mutate(points_acc = subtotal + point_fastest_conv) %>%
  arrange(desc(points_acc))
kable(union_data)
```

```{r}
racepoints_year = racepoints %>% 
  group_by(year, driver_code) %>% 
  summarise(point_year = sum(points_real), .groups = "drop")
countPoints_year <- racepoints_year %>%
  group_by(driver_code, year)%>%
  summarise(
    `Total Points per Year` = sum(point_year, na.rm = TRUE), 
    .groups = "drop") %>% 
  arrange(desc(`Total Points per Year`), desc(year))
kable(countPoints_year)

qualifypoints_year <- QualificationResult %>% 
  group_by(driver_code, year) %>%
  summarise(total_points_qualify = sum(points, na.rm = TRUE)) 

kable(qualifypoints)



# Combining countPoints and qualifypoints (excluding fastest lap)
union_data_year <- left_join(countPoints_year, qualifypoints_year, 
                        by = c("driver_code", "year"))
union_data_year <- union_data_year %>% 
  mutate(subtotal = `Total Points per Year` + total_points_qualify) %>%
  select(driver_code, year, subtotal) %>%
  arrange(desc(subtotal))
kable(union_data_year)


LapTimePerDriver_year <- laps_modified %>%
  filter(
    !is.na(LapTimeInSeconds) & LapTimeInSeconds > 0,
    IsAccurate == TRUE,
    !Deleted
  ) %>% 
  group_by(event_id) %>%
  filter(LapTimeInSeconds == min(LapTimeInSeconds, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct(event_id, .keep_all = TRUE) %>%
  select(driver_code = Driver, 
         fastest_lap_time = LapTimeInSeconds, 
         event_id, 
         year)

LapTimePerDriver_year <- LapTimePerDriver_year %>% mutate(
  points_add = 10)

fastest_lap_points_year <- LapTimePerDriver_year %>% 
  group_by(driver_code, year) %>%
  summarise(point_fastest = sum(points_add))

union_data_year <- left_join(union_data_year, fastest_lap_points_year, 
                        by = c("driver_code", "year"))

union_data_year <- union_data_year %>% 
  mutate(point_fastest_conv = case_when(
    !is.na(point_fastest) ~ point_fastest, 
    TRUE ~ 0))

union_data_year <- union_data_year %>% 
  mutate(points_year = subtotal + point_fastest_conv) %>%
  select(driver_code, year, points_year) %>%
  arrange(desc(points_year))
kable(union_data_year)

points_year <- left_join(DriverPrice, union_data_year, by = c("Driver Code" = "driver_code"))
kable(points_year)

# Categorize points by year for each driver (?)
points_by_year <- points_year %>% arrange(year) %>% pivot_wider(
  names_from = year,
  values_from = points_year,
  id_cols = c(`Driver Code`, Driver),
  values_fill = 0
) %>%
  arrange(desc(`2025`))
kable(points_by_year)

# Creating graph for each driver
all_drivers <- unique(points_year$Driver)

for (current_driver in all_drivers){
  driver_data <- points_year %>%
    filter(Driver == current_driver)
  driver_plot <- ggplot(driver_data, aes(x = year, y = points_year)) +
    geom_line() +
    geom_point(size = 2) +
    labs(x = "Year", y = "Points", 
         title = current_driver)
  print(driver_plot)
}
```

```{r}
# Linear Regression for Points-to-Price
final_driver_summary <- union_data %>%
  select(`Driver Code`, Driver, Price, points_acc) %>%
  mutate(point_per_cost = points_acc / Price) %>%
  arrange(desc(point_per_cost))

model_1 <- lm(points_acc ~ Price, data = final_driver_summary)
summary(model_1)
```

# Per event
```{r}
racepoints$event_id <- paste(racepoints$year,racepoints$event_name)
racepoints_events = racepoints %>% 
  group_by(event_id, driver_code) %>% 
  summarise(point_event = sum(points_real), .groups = "drop")
countPoints_events <- racepoints_events %>%
  group_by(driver_code, event_id)%>%
  summarise(
    `Total Points per Event` = sum(point_event, na.rm = TRUE), 
    .groups = "drop") %>% 
  arrange(desc(`Total Points per Event`), event_id)
kable(countPoints_events)

QualificationResult$event_id <- paste(QualificationResult$year, QualificationResult$event_name)
qualifypoints_events <- QualificationResult %>% 
  group_by(driver_code, event_id) %>%
  summarise(total_points_qualify = sum(points, na.rm = TRUE)) 

union_data_events <- left_join(countPoints_events, qualifypoints_events, 
                        by = c("driver_code", "event_id"))
union_data_events <- union_data_events %>% 
  mutate(subtotal = `Total Points per Event` + total_points_qualify) %>%
  select(driver_code, event_id, subtotal) %>%
  arrange(desc(subtotal))
kable(union_data_events)


LapTimePerDriver_events <- laps_modified %>%
  filter(
    !is.na(LapTimeInSeconds) & LapTimeInSeconds > 0,
    IsAccurate == TRUE,
    !Deleted
  ) %>% 
  group_by(event_id) %>%
  filter(LapTimeInSeconds == min(LapTimeInSeconds, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct(event_id, .keep_all = TRUE) %>%
  select(driver_code = Driver, 
         fastest_lap_time = LapTimeInSeconds, 
         event_id, 
         year)

LapTimePerDriver_events <- LapTimePerDriver_events %>% mutate(
  points_add = 10)

fastest_lap_points_events <- LapTimePerDriver_events %>% 
  group_by(driver_code, event_id) %>%
  summarise(point_fastest = sum(points_add))

union_data_events <- left_join(union_data_events, fastest_lap_points_events, 
                        by = c("driver_code", "event_id"))

union_data_events <- union_data_events %>% 
  mutate(point_fastest_conv = case_when(
    !is.na(point_fastest) ~ point_fastest, 
    TRUE ~ 0))

union_data_events <- union_data_events %>% 
  mutate(points_events = subtotal + point_fastest_conv) %>%
  select(driver_code, event_id, points_events) %>%
  arrange(desc(points_events))
kable(union_data_events)

points_events <- left_join(DriverPrice, union_data_events, by = c("Driver Code" = "driver_code"))
kable(points_year)

points_by_events <- points_events %>% arrange(event_id) %>% pivot_wider(
  names_from = event_id,
  values_from = points_events,
  id_cols = c(`Driver Code`, Driver),
  values_fill = 0
)
kable(points_by_events)
```

```{r}
# Average Points per Year for each Driver
racepoints_2 <- racepoints %>%
  select(driver_code,year, event_id, event_name, points_real)
head(racepoints_2)

qualifypoints_2 <- QualificationResult %>%
  group_by(driver_code, event_id) %>%
  summarise(points_sum = sum(points, na.rm = TRUE), .groups = "drop")

fastest_lap_2 <- laps_modified %>%
  filter(
    !is.na(LapTimeInSeconds) & LapTimeInSeconds > 0,
    IsAccurate == TRUE,
    !Deleted
  ) %>% 
  group_by(event_id) %>%
  filter(LapTimeInSeconds == min(LapTimeInSeconds, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct(event_id, .keep_all = TRUE) %>%
  select(driver_code = Driver, event_id) %>%
  mutate(points_lap = 10)

summary_union_data <- racepoints_2 %>%
  left_join(qualifypoints_2, by = c("driver_code", "event_id")) %>%
  left_join(fastest_lap_2, by = c("driver_code", "event_id")) %>%
  mutate(points_sum = replace_na(points_sum, 0),
         points_lap = replace_na(points_lap, 0),
         grand_total = points_real + points_sum + points_lap) %>%
  inner_join(DriverPrice, by=c("driver_code" = "Driver Code")) %>%
  select(Year = year, Event = event_name, Driver, grand_total) %>%
  arrange(Year, Event, Driver)

avg_union_data <- summary_union_data %>%
  group_by(Driver, Year) %>%
  summarise(number_events = n(),
            total_points_per_year = sum(grand_total),
            avg_points = total_points_per_year/number_events, 
            .groups = "drop") %>%
  arrange(Driver, Year)
head(avg_union_data)

points_by_year_2 <- avg_union_data %>% arrange(Year) %>% pivot_wider(
  names_from = Year,
  values_from = avg_points,
  id_cols = Driver,
  values_fill = 0
) %>%
  arrange(desc(`2025`))
kable(points_by_year_2)

ggplot(avg_union_data, aes(x = Year, y = avg_points, col = Driver)) + 
  geom_line() + 
  geom_point(size = 2) +
  labs(x = "Year", y = " Average Points", col = "Drivers")

for (current_driver in all_drivers){
  driver_data_2 <- avg_union_data %>%
    filter(Driver == current_driver)
  driver_plot_2 <- ggplot(driver_data_2, aes(x = Year, y = avg_points)) +
    geom_line() +
    geom_point(size = 2) +
    labs(x = "Year", y = " Average Points", 
         title = current_driver)
  print(driver_plot_2)
}
```

```{r}
# List all driver combinations

driver_combinations <- data.frame(D1=character(), D2=character(), D3=character(), D4=character(), D5=character(), D6=character(), D7=character(), D8=character(), D9=character(), D10=character(), D11=character(), D12=character(), D13=character(), D14=character(), D15=character(), D16=character(), D17=character(), D18=character(), D19=character(), D20=character())
for (combo in 1:20) {
  combination  <- t(combn(final_driver_summary$`Driver Code`, combo)) %>% as.data.frame()
  i = combo+1
  while(i <= 20) {
    # print(paste0(combo, ": ", i))
    # Generate random values for the new column
    new_col_values <- NA

  # Create a dynamic column name
    new_col_name <- paste0("V", i)
  
    # Assign the new column to the data frame
    combination[[new_col_name]] <- new_col_values
    i = i + 1
  }
  driver_combinations <- rbind(driver_combinations, combination)
}
```

```{r}

driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V1" = "Driver Code")) %>%
  rename(D1_Name = Driver, D1_Price = Price, D1_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V2" = "Driver Code")) %>%
  rename(D2_Name = Driver, D2_Price = Price, D2_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V3" = "Driver Code")) %>%
  rename(D3_Name = Driver, D3_Price = Price, D3_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V4" = "Driver Code")) %>%
  rename(D4_Name = Driver, D4_Price = Price, D4_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V5" = "Driver Code")) %>%
  rename(D5_Name = Driver, D5_Price = Price, D5_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V6" = "Driver Code")) %>%
  rename(D6_Name = Driver, D6_Price = Price, D6_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V7" = "Driver Code")) %>%
  rename(D7_Name = Driver, D7_Price = Price, D7_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V8" = "Driver Code")) %>%
  rename(D8_Name = Driver, D8_Price = Price, D8_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V9" = "Driver Code")) %>%
  rename(D9_Name = Driver, D9_Price = Price, D9_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V10" = "Driver Code")) %>%
  rename(D10_Name = Driver, D10_Price = Price, D10_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V11" = "Driver Code")) %>%
  rename(D11_Name = Driver, D11_Price = Price, D11_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V12" = "Driver Code")) %>%
  rename(D12_Name = Driver, D12_Price = Price, D12_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V13" = "Driver Code")) %>%
  rename(D13_Name = Driver, D13_Price = Price, D13_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V14" = "Driver Code")) %>%
  rename(D14_Name = Driver, D14_Price = Price, D14_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V15" = "Driver Code")) %>%
  rename(D15_Name = Driver, D15_Price = Price, D15_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V16" = "Driver Code")) %>%
  rename(D16_Name = Driver, D16_Price = Price, D16_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V17" = "Driver Code")) %>%
  rename(D17_Name = Driver, D17_Price = Price, D17_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V18" = "Driver Code")) %>%
  rename(D18_Name = Driver, D18_Price = Price, D18_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V19" = "Driver Code")) %>%
  rename(D19_Name = Driver, D19_Price = Price, D19_Points = points_acc)
driver_combinations <- driver_combinations %>%
  left_join(final_driver_summary, by = c("V20" = "Driver Code")) %>%
  rename(D20_Name = Driver, D20_Price = Price, D20_Points = points_acc)
# Calculate the rate of team points gain per team cost, show the top 10
winning <- driver_combinations %>%
  mutate(
    team_cost = sum(paste0("D", i, "_Price"), na.rm = TRUE),
    team_points = sum(paste0("D", i, "_Points"), na.rm=TRUE),
    team_points_cost = team_points / team_cost
  ) %>%
  arrange(desc(team_points)) %>%
  select(D1_Name, D2_Name, D3_Name, D4_Name, D5_Name, D6_Name, D7_Name, D8_Name, D9_Name, D10_Name, D11_Name, D12_Name, D13_Name, D14_Name, D15_Name, D16_Name, D17_Name, D18_Name, D19_Name, D20_Name, team_points, team_cost, team_points_cost)

kable(head(winning, 1))

# Plot the points based on team cost and team price and highlight the team that has the highest points
ggplot(winning, aes(x = team_points, y = team_points/team_cost)) +
  geom_point(color = "grey") + 
  geom_point(data = head(winning, 1), color = "red", size = 3) +
  labs(
    title = "Optimization: Cost vs. Points",
    subtitle = "Each dot is a unique pair of drivers",
    x = "Total Budget Required ($M)",
    y = "Points/Budget"
  ) +
  theme_minimal()
```

```{r}
# Download the dataset in .csv file
write_csv(final_driver_summary, "driver_summary.csv")
write_csv(avg_union_data, "driver_trends.csv")
write_csv(winning, "optimal_teams.csv")
```


```{r}
# PS: I use Gemini AI to find all best combinations per groups of drivers

# 1. Filter Positive Drivers
positive_drivers <- final_driver_summary %>% filter(points_acc > 0)
driver_codes <- positive_drivers$`Driver Code`
prices <- setNames(positive_drivers$Price, driver_codes)
points <- setNames(positive_drivers$points_acc, driver_codes)
budget_cap <- 100

# 2. Results Container
results_list <- list()

# 3. Loop through team sizes (k)
max_drivers <- length(driver_codes)

for (k in 2:max_drivers) {
  
  # A. Generate Combinations
  combos <- combn(driver_codes, k)
  
  # B. Calculate Cost & Points (Vectorized - No Left Join needed!)
  team_costs <- colSums(matrix(prices[combos], nrow = k))
  team_points <- colSums(matrix(points[combos], nrow = k))
  
  # C. Create Table
  temp_df <- data.frame(
    Team_Size = k,
    Total_Cost = team_costs,
    Total_Points = team_points,
    Rate_Points_Cost = team_points/team_costs,
    # Create the string "Driver1, Driver2, ..."
    Drivers = apply(combos, 2, paste, collapse = ", ")
  )
  
  # D. Filter & Find Winner
  best_team <- temp_df %>%
    filter(Total_Cost <= budget_cap) %>%
    arrange(desc(Total_Points)) %>%
    head(1)
  
  # E. Save Result
  if (nrow(best_team) > 0) {
    results_list[[k]] <- best_team
  } else {
    break 
  }
}

# 4. Final Table
scenario_analysis <- bind_rows(results_list)

# 5. Display
kable(scenario_analysis)

# 6. Plot (Cost vs Points for the Best Team of Each Size)
ggplot(scenario_analysis, aes(x = Total_Cost, y = Total_Points)) +
  geom_point(size = 3, color = "blue") +
  geom_text(aes(label = paste("Size", Team_Size)), vjust = -0.5) +
  labs(
    title = "Optimization: Best Team for Each Size",
    x = "Total Cost ($M)",
    y = "Total Points"
  ) +
  theme_minimal()
```
