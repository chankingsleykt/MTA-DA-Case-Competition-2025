---
title: "DA Competition"
author: "The Four Quadrants"
date: "2025-11-11"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE}
# Datasets
rm(list=ls()) # Clear the console
graphics.off() # Clear the graphics window
options(scipen=20) # Turn off scientific notation
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("readr")) install.packages("readr")
if (!require("lubridate")) install.packages("lubridate")
if (!require("sqldf")) install.packages("sqldf")
library(sqldf)
library(lubridate)
library(tidyverse)
library(knitr)
library(sqldf)
Constructors <- read_csv("DA Competition/Constructors.csv")

DriverPrice <- read_csv("DA Competition/DriverPrice.csv")

Drivers <- read_csv("DA Competition/Drivers.csv")

laps <- read_csv("DA Competition/laps.csv")

QualificationResult <- read_csv("DA Competition/QualificationResult.csv")

RaceResult <- read_csv("DA Competition/RaceResult.csv")

RaceSchedule <- read_csv("DA Competition/RaceSchedule.csv")
```

```{r}
# Converting status in RaceResult
RaceResult <- RaceResult %>%
  mutate(status_conv = case_when(
    status %in% c("+2 Laps", 
                "+1 Lap", 
                "+5 Laps", 
                "+3 Laps", 
                "Finished", 
                "Lapped", 
                "+6 Laps") ~ "Finished",
    TRUE ~ "Not Finished"
  ))

## Convert to points based on position and status in RaceResult dataset
racepoints <- RaceResult %>%
  mutate(points_conv = case_when(
    (position == 1 & status_conv == "Finished") ~ 25,
    (position == 2 & status_conv == "Finished") ~ 18,
    (position == 3 & status_conv == "Finished") ~ 15,
    (position == 4 & status_conv == "Finished")~ 12,
    (position == 5 & status_conv == "Finished") ~ 10,
    (position == 6 & status_conv == "Finished") ~ 8,
    (position == 7 & status_conv == "Finished") ~ 6,
    (position == 8 & status_conv == "Finished") ~ 4,
    (position == 9 & status_conv == "Finished") ~ 1,
    (position == 10 & status_conv == "Finished") ~ 0,
    (position %in% c(11, 12, 13, 14, 15, 16, 17, 18, 19, 20) &
       status_conv == "Finished") ~ 0,
    TRUE ~ -20
  ),
  point_gain_loss = ifelse( # Calculate points from position gained and lost
    is.na(grid_position) | is.na(position),
    0, 
    grid_position - position
  ))

# Sum up points
racepoints <- racepoints %>% 
  mutate(points_real = points_conv + point_gain_loss)

# Combine DriverPrice and racepoints
DriverPriceResult <- left_join(DriverPrice, racepoints, 
                               by = c("Driver Code"= "driver_code"))

# Combining points per driver
countPoints <- DriverPriceResult %>%
  group_by(`Driver Code`, `Driver`)%>%
  summarise(
    `Price` = max(Price), 
    `Total Points` = sum(points_real, na.rm = TRUE), 
    .groups = "drop") %>% 
  arrange(desc(`Total Points`))
kable(countPoints)

### Miscellaneous - checking NA's in position and grid_position column
RR_Miscellaneous <- racepoints %>%
  filter(is.na(position) | is.na(grid_position))
```

## Qualification Result Table
```{r}
# Converting positions to points
QualificationResult <- QualificationResult %>% 
  mutate(points = case_when(
  position == 1 ~ 10,
  position == 2 ~ 9,
  position == 3 ~ 8,
  position == 4 ~ 7,
  position == 5 ~ 6,
  position == 6 ~ 5,
  position == 7 ~ 4,
  position == 8 ~ 3,
  position == 9 ~ 2,
  position == 10 ~ 1,
  TRUE ~ 0
))

#Sum all the points
qualifypoints <- QualificationResult %>% 
  group_by(driver_code) %>%
  summarise(total_points_qualify = sum(points, na.rm = TRUE)) 

kable(qualifypoints)

# Combining countPoints and qualifypoints (excluding fastest lap)
union_data <- left_join(countPoints, qualifypoints, 
                        by = c("Driver Code" = "driver_code"))
union_data <- union_data %>% 
  mutate(subtotal = `Total Points` + total_points_qualify) %>%
  arrange(desc(subtotal))
kable(union_data)
```

```{r}

laps_modified <- laps %>% mutate(LapTimeInSeconds = (as.numeric(str_extract(LapTime, "\\d{2}(?=:\\d{2}\\.\\d)")) * 60) + as.numeric(str_extract(LapTime, "\\d{2}\\.\\d+")))

# add a new id column in RaceResult and laps_modified that assigns a unique id to each event
RaceResult$event_id <- paste(RaceResult$year,RaceResult$event_name)
laps_modified$event_id <- paste(laps_modified$year,laps_modified$event_name)

# construct a table that displays the driver and the minimum lap time per event. Note laps_modified contains entries where LapTimeInSeconds is 0 at the start of every new driver's records, these values have been rejected  
LapTimePerDriver <- sqldf("SELECT Driver, MIN(LapTimeInSeconds), event_id FROM laps_modified WHERE LapTimeInSeconds > 0 AND IsAccurate = TRUE AND Deleted = FALSE GROUP BY event_id")


LapTimePerDriver <- LapTimePerDriver %>%
  mutate(points_add = 10) %>%
  rename(driver_code = Driver)

fastest_lap_points_acc <- LapTimePerDriver %>% 
  group_by(driver_code) %>%
  summarise(point_fastest = sum(points_add))

union_data <- left_join(union_data, fastest_lap_points_acc, by = c("Driver Code" = "driver_code"))

union_data <- union_data %>% 
  mutate(point_fastest_conv = case_when(
    !is.na(point_fastest) ~ point_fastest, 
    TRUE ~ 0))

union_data <- union_data %>%
  mutate(points_acc = subtotal + point_fastest_conv) %>%
  arrange(desc(points_acc))
kable(union_data)
```

```{r}

racepoints_year = racepoints %>% 
  group_by(year, driver_code) %>% 
  summarise(point_year = sum(points_real), .groups = "drop")
countPoints_year <- racepoints_year %>%
  group_by(driver_code, year)%>%
  summarise(
    `Total Points per Year` = sum(point_year, na.rm = TRUE), 
    .groups = "drop") %>% 
  arrange(desc(`Total Points per Year`), desc(year))
head(countPoints_year)

qualifypoints_year <- QualificationResult %>% 
  group_by(driver_code, year) %>%
  summarise(total_points_qualify = sum(points, na.rm = TRUE)) 

head(qualifypoints)



# Combining countPoints and qualifypoints (excluding fastest lap)
union_data_year <- left_join(countPoints_year, qualifypoints_year, 
                        by = c("driver_code", "year"))
union_data_year <- union_data_year %>% 
  mutate(subtotal = `Total Points per Year` + total_points_qualify) %>%
  select(driver_code, year, subtotal) %>%
  arrange(desc(subtotal))
head(union_data_year)


LapTimePerDriver_year <- laps_modified %>%
  filter(
    !is.na(LapTimeInSeconds) & LapTimeInSeconds > 0,
    IsAccurate == TRUE,
    !Deleted
  ) %>% 
  group_by(event_id) %>%
  filter(LapTimeInSeconds == min(LapTimeInSeconds, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct(event_id, .keep_all = TRUE) %>%
  select(driver_code = Driver, 
         fastest_lap_time = LapTimeInSeconds, 
         event_id, 
         year)

LapTimePerDriver_year <- LapTimePerDriver_year %>% mutate(
  points_add = 10)

fastest_lap_points_year <- LapTimePerDriver_year %>% 
  group_by(driver_code, year) %>%
  summarise(point_fastest = sum(points_add))

union_data_year <- left_join(union_data_year, fastest_lap_points_year, 
                        by = c("driver_code", "year"))

union_data_year <- union_data_year %>% 
  mutate(point_fastest_conv = case_when(
    !is.na(point_fastest) ~ point_fastest, 
    TRUE ~ 0))

union_data_year <- union_data_year %>% 
  mutate(points_year = subtotal + point_fastest_conv) %>%
  select(driver_code, year, points_year) %>%
  arrange(desc(points_year))
head(union_data_year)

points_year <- left_join(DriverPrice, union_data_year, by = c("Driver Code" = "driver_code"))
head(points_year)

points_by_year <- points_year %>% arrange(year) %>% pivot_wider(
  names_from = year,
  values_from = points_year,
  id_cols = c(`Driver Code`, Driver),
  values_fill = 0
) %>%
  arrange(desc(`2025`))
head(points_by_year)

all_drivers <- unique(points_year$Driver)

for (current_driver in all_drivers){
  driver_data <- points_year %>%
    filter(Driver == current_driver)
  driver_plot <- ggplot(driver_data, aes(x = year, y = points_year)) +
    geom_line() +
    geom_point(size = 2) +
    labs(x = "Year", y = "Points", 
         title = current_driver)
  print(driver_plot)
}
```

```{r}
final_driver_summary <- union_data %>%
  select(`Driver Code`, Driver, Price, points_acc) %>%
  mutate(point_per_cost = points_acc / Price) %>%
  arrange(desc(point_per_cost))

model_1 <- lm(points_acc ~ Price, data = final_driver_summary)
summary(model_1)
```

```{r}
racepoints$event_id <- paste(racepoints$year,racepoints$event_name)
racepoints_events = racepoints %>% 
  group_by(event_id, driver_code) %>% 
  summarise(point_event = sum(points_real), .groups = "drop")
countPoints_events <- racepoints_events %>%
  group_by(driver_code, event_id)%>%
  summarise(
    `Total Points per Event` = sum(point_event, na.rm = TRUE), 
    .groups = "drop") %>% 
  arrange(desc(`Total Points per Event`), event_id)
head(countPoints_events)

QualificationResult$event_id <- paste(QualificationResult$year, QualificationResult$event_name)
qualifypoints_events <- QualificationResult %>% 
  group_by(driver_code, event_id) %>%
  summarise(total_points_qualify = sum(points, na.rm = TRUE)) 

union_data_events <- left_join(countPoints_events, qualifypoints_events, 
                        by = c("driver_code", "event_id"))
union_data_events <- union_data_events %>% 
  mutate(subtotal = `Total Points per Event` + total_points_qualify) %>%
  select(driver_code, event_id, subtotal) %>%
  arrange(desc(subtotal))
head(union_data_events)


LapTimePerDriver_events <- laps_modified %>%
  filter(
    !is.na(LapTimeInSeconds) & LapTimeInSeconds > 0,
    IsAccurate == TRUE,
    !Deleted
  ) %>% 
  group_by(event_id) %>%
  filter(LapTimeInSeconds == min(LapTimeInSeconds, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct(event_id, .keep_all = TRUE) %>%
  select(driver_code = Driver, 
         fastest_lap_time = LapTimeInSeconds, 
         event_id, 
         year)

LapTimePerDriver_events <- LapTimePerDriver_events %>% mutate(
  points_add = 10)

fastest_lap_points_events <- LapTimePerDriver_events %>% 
  group_by(driver_code, event_id) %>%
  summarise(point_fastest = sum(points_add))

union_data_events <- left_join(union_data_events, fastest_lap_points_events, 
                        by = c("driver_code", "event_id"))

union_data_events <- union_data_events %>% 
  mutate(point_fastest_conv = case_when(
    !is.na(point_fastest) ~ point_fastest, 
    TRUE ~ 0))

union_data_events <- union_data_events %>% 
  mutate(points_events = subtotal + point_fastest_conv) %>%
  select(driver_code, event_id, points_events) %>%
  arrange(desc(points_events))
head(union_data_events)

points_events <- left_join(DriverPrice, union_data_events, by = c("Driver Code" = "driver_code"))
head(points_events)

points_by_events <- points_events %>% arrange(event_id) %>% pivot_wider(
  names_from = event_id,
  values_from = points_events,
  id_cols = c(`Driver Code`, Driver),
  values_fill = 0
)
```

```{r}
racepoints_2 <- racepoints %>%
  select(driver_code,year, event_id, event_name, points_real)
head(racepoints_2)

qualifypoints_2 <- QualificationResult %>%
  group_by(driver_code, event_id) %>%
  summarise(points_sum = sum(points, na.rm = TRUE), .groups = "drop")

fastest_lap_2 <- laps_modified %>%
  filter(
    !is.na(LapTimeInSeconds) & LapTimeInSeconds > 0,
    IsAccurate == TRUE,
    !Deleted
  ) %>% 
  group_by(event_id) %>%
  filter(LapTimeInSeconds == min(LapTimeInSeconds, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct(event_id, .keep_all = TRUE) %>%
  select(driver_code = Driver, event_id) %>%
  mutate(points_lap = 10)

summary_union_data <- racepoints_2 %>%
  left_join(qualifypoints_2, by = c("driver_code", "event_id")) %>%
  left_join(fastest_lap_2, by = c("driver_code", "event_id")) %>%
  mutate(points_sum = replace_na(points_sum, 0),
         points_lap = replace_na(points_lap, 0),
         grand_total = points_real + points_sum + points_lap) %>%
  inner_join(DriverPrice, by=c("driver_code" = "Driver Code")) %>%
  select(Year = year, Event = event_name, Driver, grand_total) %>%
  arrange(Year, Event, Driver)

avg_union_data <- summary_union_data %>%
  group_by(Driver, Year) %>%
  summarise(number_events = n(),
            total_points_per_year = sum(grand_total),
            avg_points = total_points_per_year/number_events, 
            .groups = "drop") %>%
  arrange(Driver, Year)
head(avg_union_data)

points_by_year_2 <- avg_union_data %>% arrange(Year) %>% pivot_wider(
  names_from = Year,
  values_from = avg_points,
  id_cols = Driver,
  values_fill = 0
) %>%
  arrange(desc(`2025`))
kable(points_by_year_2)

ggplot(avg_union_data, aes(x = Year, y = avg_points, col = Driver)) + 
  geom_line() + 
  geom_point(size = 2) +
  labs(x = "Year", y = " Average Points", col = "Drivers")

for (current_driver in all_drivers){
  driver_data_2 <- avg_union_data %>%
    filter(Driver == current_driver)
  driver_plot_2 <- ggplot(driver_data_2, aes(x = Year, y = avg_points)) +
    geom_line(aes(group = 1), color = "blue", linewidth = 1) +
    geom_point(size = 2) +
    scale_x_continuous(breaks = unique(driver_data_2$Year)) +
    labs(x = "Year", y = " Average Points", 
         title = current_driver)
  print(driver_plot_2)
}
```

```{r}
# Download the dataset in .csv file
write_csv(final_driver_summary, "driver_summary.csv")
write_csv(avg_union_data, "driver_trends.csv")
write_csv(winning, "optimal_teams.csv")
```


```{r}
points_2025 <- points_by_year %>% 
  select(`Driver Code`,Driver, `2025`) %>%
  rename(pts = `2025`)
points_2025 <- points_2025 %>%
  left_join(DriverPrice, by = "Driver Code") %>%
  mutate(rate = pts/Price) %>%
  select(-Driver.y) %>%
  rename(Driver = Driver.x)
```

```{r}
# --- COMPREHENSIVE SCENARIO ANALYSIS (Sizes 2 to 10) WITH NAMES ---

# 1. Setup: Filter for positive drivers only
positive_drivers <- points_2025 %>% filter(pts > 0)
driver_codes <- positive_drivers$`Driver Code`

# Create vectors for fast math
prices <- setNames(positive_drivers$Price, driver_codes)
points <- setNames(positive_drivers$pts, driver_codes)

# --- NEW: Create a Name Lookup Map ---
names_map <- setNames(positive_drivers$Driver, driver_codes) 

# 2. Create a list to store ALL valid teams
all_valid_teams_list <- list()

# 3. Loop from Size 2 to Size 10
for (k in 2:10) {
  
  # A. Generate Combinations (Matrix where each col is a team)
  combos <- combn(driver_codes, k)
  
  # B. Calculate Cost & Points (Vectorized Speed)
  team_costs <- colSums(matrix(prices[combos], nrow = k))
  team_points <- colSums(matrix(points[combos], nrow = k))
  
  # C. Create Table
  temp_df <- data.frame(
    Team_Size = k,
    Total_Cost = team_costs,
    Total_Points = team_points,
    Rate_Points_Cost = team_points/team_costs,
    
    # --- CHANGED: Convert Codes to Names before pasting ---
    Drivers = apply(combos, 2, function(col) {
      # Look up the full names
      full_names <- names_map[col]
      # Paste them together with a comma
      paste(full_names, collapse = ", ")
    })
  )
  
  # D. Filter for Budget
  # We keep ALL teams that fit the budget
  valid_teams <- temp_df %>%
    filter(Total_Cost <= 100) %>%
    arrange(desc(Total_Points))
  
  # E. Save the results if any valid teams exist
  if (nrow(valid_teams) > 0) {
    all_valid_teams_list[[k]] <- valid_teams
  } else {
    message(paste("No teams fit the budget at size:", k))
  }
}

# 4. Combine into one Big Dataframe
all_possible_combinations <- bind_rows(all_valid_teams_list)

# 5. Show the Best Team for EACH Size
best_per_size <- all_possible_combinations %>%
  group_by(Team_Size) %>%
  slice_max(Total_Points, n = 1) %>%
  arrange(Team_Size)

kable(best_per_size, caption = "Best Feasible Team by Size (2-10 Drivers)")

# 6. (Optional) View the Top 10 Best Teams Overall (Any Size)
kable(head(all_possible_combinations %>% arrange(desc(Total_Points)), 10), 
      caption = "Top 10 Best Teams Overall (Any Size)")
```
